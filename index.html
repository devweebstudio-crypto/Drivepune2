<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Car Rental – Home</title>

<!-- Simple CSS -->
<style>
    body {
        font-family: Arial, sans-serif;
        margin: 0;
        background: #f7f7f7;
    }

    header {
        background: #111;
        color: #fff;
        padding: 15px;
        text-align: center;
        font-size: 20px;
        letter-spacing: 1px;
    }

    .container {
        padding: 15px;
        max-width: 900px;
        margin: auto;
    }

    #searchInput {
        width: 100%;
        padding: 12px;
        font-size: 16px;
        border: 1px solid #ddd;
        border-radius: 6px;
        margin-bottom: 20px;
    }

    .car-card {
        background: white;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        margin-bottom: 20px;
        display: flex;
        gap: 15px;
        align-items: center;
    }

    .car-card img {
        width: 150px;
        height: 100px;
        border-radius: 6px;
        object-fit: cover;
    }

    .car-info {
        flex: 1;
    }

    .btn {
        padding: 10px 15px;
        border: none;
        background: #111;
        color: white;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
    }
    .btn:hover { background: #333; }

    /* Popup Modal */
    #enquiryModal {
        display: none;
        position: fixed;
        top: 0; left: 0;
        width: 100%; height: 100%;
        background: rgba(0,0,0,0.6);
        justify-content: center;
        align-items: center;
    }

    .modal-content {
        background: white;
        padding: 20px;
        width: 90%;
        max-width: 400px;
        border-radius: 8px;
    }

    .modal-content input {
        width: 100%;
        padding: 10px;
        margin: 8px 0;
        border: 1px solid #ddd;
        border-radius: 6px;
    }

    .close-btn {
        float: right;
        cursor: pointer;
        color: #444;
    }
</style>

</head>
<body>

<header>Car Rental – Self Drive</header>

<div class="container">

    <input type="text" id="searchInput" placeholder="Search cars (ex: petrol, 5 seater, creta)">

    <div id="carList">Loading cars...</div>

</div>

<!-- Enquiry Modal -->
<div id="enquiryModal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeModal()">✖</span>
        <h3>Enquiry Now</h3>

        <input type="text" id="qName" placeholder="Your Name">
        <input type="text" id="qPhone" placeholder="Mobile Number">
        <input type="date" id="qStart">
        <input type="date" id="qEnd">
        <input type="text" id="qLocation" placeholder="Location (optional)">
        <button class="btn" onclick="submitEnquiry()">Submit</button>
    </div>
</div>

<!-- SUPABASE -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
// ----------------- SUPABASE INIT -----------------
const SUPABASE_URL = "https://diqgdlodnjtuekouxjsz.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRpcWdkbG9kbmp0dWVrb3V4anN6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMzNzMwMDksImV4cCI6MjA3ODk0OTAwOX0.aK_CKsaEfHxYKvR68xDpWglkvNr5GxkiNNKqleR_mzA";

const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// ----------------- LOAD CARS -----------------
let globalCars = [];

async function loadCars() {
    const { data, error } = await db
        .from("cars")
        .select("*, car_images(image_url)");

    if (error) {
        document.getElementById("carList").innerHTML = "Error loading cars";
        return;
    }

    globalCars = data;
    displayCars(data);
}

// ----------------- DISPLAY CARS -----------------
function displayCars(cars) {
    const box = document.getElementById("carList");
    box.innerHTML = "";

    if (cars.length === 0) {
        box.innerHTML = "No cars found";
        return;
    }

    cars.forEach(car => {
        const img = car.car_images?.[0]?.image_url || "https://placehold.co/150x100";

        box.innerHTML += `
            <div class="car-card">
                <img src="${img}">
                <div class="car-info">
                    <h3>${car.name}</h3>
                    <p>${car.fuel_type} • ${car.seating} Seater • ${car.transmission}</p>
                    <p><b>₹${car.price_per_day}/day</b></p>
                </div>
                <div>
                    <button class="btn" onclick="openModal(${car.id})">Enquiry</button><br><br>
                    <a href="car.html?id=${car.id}"><button class="btn">More Details</button></a>
                </div>
            </div>
        `;
    });
}

// ----------------- SEARCH -----------------
document.getElementById("searchInput").addEventListener("input", function() {
    let q = this.value.toLowerCase();
    let filtered = globalCars.filter(c =>
        c.name.toLowerCase().includes(q) ||
        c.brand.toLowerCase().includes(q) ||
        c.model.toLowerCase().includes(q) ||
        c.fuel_type.toLowerCase().includes(q) ||
        c.transmission.toLowerCase().includes(q) ||
        String(c.seating).includes(q)
    );
    displayCars(filtered);
});

// ----------------- ENQUIRY FORM -----------------
let selectedCarId = null;

function openModal(carId) {
    selectedCarId = carId;
    document.getElementById("enquiryModal").style.display = "flex";
}

function closeModal() {
    document.getElementById("enquiryModal").style.display = "none";
}

async function submitEnquiry() {
    const name = document.getElementById("qName").value.trim();
    const phone = document.getElementById("qPhone").value.trim();
    const start = document.getElementById("qStart").value;
    const end = document.getElementById("qEnd").value;
    const location = document.getElementById("qLocation").value.trim();

    if (!name || !phone || !start || !end) {
        alert("Please fill all required fields.");
        return;
    }

    const { error } = await db.from("bookings").insert({
        car_id: selectedCarId,
        name, phone,
        start_date: start,
        end_date: end,
        location
    });

    if (error) {
        alert("Error submitting enquiry.");
        return;
    }

    alert("Enquiry submitted successfully!");
    closeModal();
}

// Load cars on page load
loadCars();

</script>

</body>
</html>
